{"name":"OPTIMISED: Email Order CSV and Images When an Order is Created","options":{"order_name":"#1198","max_batch_size__required__number":"30","test__boolean":false,"to":"tobywynnemellor@gmail.com"},"subscriptions":["mechanic/user/trigger","mechanic/shopify/bulk_operation","shopify/orders/create+1.minute"],"subscriptions_template":null,"script":"{% if event.topic == \"mechanic/user/trigger\" %}\n    {% assign order_name = options.order_name %}\n{% elsif event.topic == \"shopify/orders/create\" %}\n  {% assign order = order.reload %}\n  {% assign order_name = order.name %}\n{% endif %}\n\n{% if event.topic == \"mechanic/user/trigger\" or event.topic == \"shopify/orders/create\" %}\n\n{% action \"echo\" %}\n  {\n    \"order-name\": {{order_name | json}},\n    \"order\": {{order |json}}\n  }\n{% endaction %}\n\n{% capture query %}\n    query {\n      orders(query: {{ order_name | json | json }}) {\n        edges {\n          node {\n            id\n            __typename \n            name\n            email\n            lineItems {\n              edges {\n                node {\n                  id\n                  __typename \n                  title\n                  variant {\n                    id\n                    __typename \n                    sku\n                    price\n                    barcode\n                    selectedOptions {\n                      value  \n                    }\n                  }\n                  product {\n                    id\n                    __typename\n                    handle\n                    metafields {\n                      edges {\n                        node {\n                          id\n                          __typename \n                          key\n                          value\n                        }\n                      }\n                    }\n                    images {\n                      edges {\n                        node {\n                          id\n                          __typename \n                          originalSrc\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  {% endcapture %}\n\n  {% action \"shopify\" %}\n    mutation {\n      bulkOperationRunQuery(\n        query: {{ query | json }}\n      ) {\n        bulkOperation {\n          id\n          status\n        }\n        userErrors {\n          field\n          message\n        }\n      }\n    }\n  {% endaction %}\n\n{% elsif event.topic ==  \"mechanic/shopify/bulk_operation\" %}\n\n  {% assign query_results = bulkOperation.objects %}\n\n  {% if event.preview %}\n    {% capture result_json %}\n    [\n      {\n        \"id\": \"gid://shopify/Order/3163744895127\",\n        \"__typename\": \"Order\",\n        \"name\": \"#1125\",\n        \"email\": \"hello@rockitkids.co.uk\"\n      },\n      {\n        \"id\": \"gid://shopify/LineItem/6669422231703\",\n        \"__typename\": \"LineItem\",\n        \"title\": \"Organic Multi Rainbow Yoga Pants\",\n        \"variant\": {\n          \"id\": \"gid://shopify/ProductVariant/35085641646231\",\n          \"__typename\": \"ProductVariant\",\n          \"sku\": \"TRYOGMRAIN04\",\n          \"barcode\": \"5055490139025\",\n          \"selectedOptions\": [\n            {\n              \"value\": \"1-2y / 92cm\"\n            }\n          ]\n        },\n        \"product\": {\n          \"id\": \"gid://shopify/Product/5392382754967\",\n          \"__typename\": \"Product\",\n          \"handle\": \"tryogmrain-organic-multi-rainbow-yoga-pants\"\n        },\n        \"__parentId\": \"gid://shopify/Order/3163744895127\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358647959\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-1.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422231703\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358680727\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-LIFE.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422231703\"\n      },\n      {\n        \"id\": \"gid://shopify/LineItem/6669422264471\",\n        \"__typename\": \"LineItem\",\n        \"title\": \"Organic Multi Rainbow Yoga Pants\",\n        \"variant\": {\n          \"id\": \"gid://shopify/ProductVariant/35085641613463\",\n          \"__typename\": \"ProductVariant\",\n          \"sku\": \"TRYOGMRAIN03\",\n          \"barcode\": \"5055490139018\",\n          \"selectedOptions\": [\n            {\n              \"value\": \"6-12m / 80cm\"\n            }\n          ]\n        },\n        \"product\": {\n          \"id\": \"gid://shopify/Product/5392382754967\",\n          \"__typename\": \"Product\",\n          \"handle\": \"tryogmrain-organic-multi-rainbow-yoga-pants\"\n        },\n        \"__parentId\": \"gid://shopify/Order/3163744895127\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358647959\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-1.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422264471\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358680727\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-LIFE.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422264471\"\n      },\n      {\n        \"id\": \"gid://shopify/LineItem/6669422297239\",\n        \"__typename\": \"LineItem\",\n        \"title\": \"Organic Multi Rainbow Yoga Pants\",\n        \"variant\": {\n          \"id\": \"gid://shopify/ProductVariant/35085641580695\",\n          \"__typename\": \"ProductVariant\",\n          \"sku\": \"TRYOGMRAIN02\",\n          \"barcode\": \"5055490139001\",\n          \"selectedOptions\": [\n            {\n              \"value\": \"3-6m / 68cm\"\n            }\n          ]\n        },\n        \"product\": {\n          \"id\": \"gid://shopify/Product/5392382754967\",\n          \"__typename\": \"Product\",\n          \"handle\": \"tryogmrain-organic-multi-rainbow-yoga-pants\"\n        },\n        \"__parentId\": \"gid://shopify/Order/3163744895127\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358647959\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-1.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422297239\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358680727\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-LIFE.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422297239\"\n      },\n      {\n        \"id\": \"gid://shopify/LineItem/6669422330007\",\n        \"__typename\": \"LineItem\",\n        \"title\": \"Organic Multi Rainbow Yoga Pants\",\n        \"variant\": {\n          \"id\": \"gid://shopify/ProductVariant/35085641547927\",\n          \"__typename\": \"ProductVariant\",\n          \"sku\": \"TRYOGMRAIN01\",\n          \"barcode\": \"5055490138998\",\n          \"selectedOptions\": [\n            {\n              \"value\": \"0-3m / 56cm\"\n            }\n          ]\n        },\n        \"product\": {\n          \"id\": \"gid://shopify/Product/5392382754967\",\n          \"__typename\": \"Product\",\n          \"handle\": \"tryogmrain-organic-multi-rainbow-yoga-pants\"\n        },\n        \"__parentId\": \"gid://shopify/Order/3163744895127\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358647959\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-1.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422330007\"\n      },\n      {\n        \"id\": \"gid://shopify/ProductImage/17996358680727\",\n        \"__typename\": \"Image\",\n        \"originalSrc\": \"https://cdn.shopify.com/s/files/1/0413/8483/7271/products/Organic-Multi-Rainbow-yoga-Pants-TRYOGMRAIN-LIFE.jpg?v=1595272941\",\n        \"__parentId\": \"gid://shopify/LineItem/6669422330007\"\n      }\n    ]\n    {% endcapture %}\n    {% assign query_results = result_json | parse_json %}\n  {% endif %}\n\n  {% assign order_node = query_results | where: \"__typename\", \"Order\" | first %}\n  {% assign order_name = order_node.name %}\n  {% assign email = order_node.email %}\n  {% assign line_items = query_results | where: \"__typename\", \"LineItem\" %}\n  {% assign variants = line_items | map: \"variant\" %}\n  {% assign images = query_results | where: \"__typename\", \"Image\" | map: \"originalSrc\" | uniq %}\n \n  {% assign metafields = query_results | where: \"__typename\", \"Metafield\" %}\n\n  {% action \"echo\" %}\n    {\n      \"order_name\" : {{ order_name | json }},\n      \"email\" : {{ email | json}},\n      \"skus\": {{ variants | map: \"sku\" | json }},\n      \"prices\": {{ variants | map: \"price\" | json }},\n      \"images\": {{ images | json }},\n      \"metafields\": {{ metafields | json }},\n      \"query_result\": {{query_results | json }}\n    }  \n  {% endaction %}\n  \n  {% assign rows = array %}\n\n  {% assign header = array %}\n  {% assign header[0] = \"Title\" %}\n  {% assign header[1] = \"SKU\" %}\n  {% assign header[2] = \"Size\" %}\n  {% assign header[3] = \"Barcode\" %}\n  {% assign header[4] = \"Description\" %}\n  {% assign header[5] = \"Wholesale Price\" %}\n  {% assign header[6] = \"RRP\" %}\n  \n  {% assign rows[0] = header %}\n  \n  {% for line_item in line_items %}\n    {% assign row = array %}\n    {% assign row[0] = line_item.title %}\n    {% assign row[1] = line_item.variant.sku %}\n    {% assign row[2] = line_item.variant.selectedOptions[0].value %}\n    {% assign row[3] = line_item.variant.barcode %}\n    {% assign line_item_metafields = metafields | where: \"__parentId\", line_item.id %}\n    {% assign description = line_item_metafields | where: \"key\", \"Description\" | map: \"value\" | sample %}\n    {% assign row[4] = description %}\n    {% assign row[5] = line_item.variant.price %}\n    {% assign rrp = line_item_metafields | where: \"key\", \"RRP\" | map: \"value\" | sample %}\n    {% assign row[6] = rrp %}\n \n\n    {% log rrp %}\n    {% log description %}\n\n    {% assign rows[rows.size] = row %}\n  {% endfor %}\n  {% assign csv = rows | csv %}\n\n  \n\n  {% capture image_jsonl %}\n    {% for image in images %}\n      {% assign img_name = image | split: \"/\" | last | split: '?' | first %}\n      \"{{img_name}}\": {\"url\" : \"{{ image | img_url: 'x2000' }}\"}\n      {% unless forloop.last %},{% endunless %}\n    {% endfor %}\n  {% endcapture %}\n       \n  {% assign image_jsonl = image_jsonl | strip | split: ',' %}\n  \n  {% assign image_chunks = array %}\n\n  {% assign max_batch_size = options.max_batch_size__required__number%}\n\n  {% action \"echo\" %}\n    {\n      \"image count\" : {{image_jsonl.size | json}},\n      \"image chunks\" : {{image_jsonl.size | divided_by: max_batch_size | plus: 1 | json}}\n    }  \n  {% endaction %}\n\n  {% for image in image_jsonl %}\n    {% assign batch_indx = forloop.index | divided_by: max_batch_size %}\n    {% assign last_indx = image_chunks.size %}\n    {% if batch_indx == last_indx %}\n      {% assign image_chunks[batch_indx] = image %}\n    {% else %}\n      {% assign image_chunks[batch_indx] = image_chunks[batch_indx] | append: \",\" | append: image %}\n    {% endif %}\n  {% endfor %}\n\n  {% assign batches = false %}\n  {% if image_chunks.size > 1 %}\n    {% assign batches = true %}\n  {% endif %}\n\n  {% for chunk in image_chunks %}\n    {% capture subject %}Order {{ order_node.name }} Downloads{% if batches %} batch: {{forloop.index}}/{{image_chunks.size}}{% endif %}{% endcapture %}\n    {% assign subject = subject | strip_newlines %}\n\n    {% capture csv_filename %}Order-{{order_name}}_product_data.csv{% endcapture %}\n    {% capture zip_filename %}Order-{{order_name}}_images{% if batches %}_{{forloop.index}}-of-{{image_chunks.size}}{% endif %}.zip{% endcapture %}\n \n    {% capture body %}\n      {% if forloop.index < 2 %}\n      <h2 style=\"text-align: center; color: #006EB6\">Here are your downloads!</h2>\n      <p>Just in case you need it, here is the product data associated with your order <strong>{{order_name}}</strong>.</p>\n      <p>Please find attached the product data spreadsheet <strong>({{csv_filename}})</strong> and the product images <strong>({{zip_filename}})</strong>.</p>\n        <p>The data spreadsheet contains the following information:</p>\n        <ol>\n          <li>Product Title</li>\n          <li>Product SKU</li>\n          <li>Product Size</li>\n          <li>Product Barcode</li>\n          <li>Product Description (missing for some products - we're working on this)</li>\n          <li>Product Wholesale Price</li>\n          <li>Product RRP (missing for some products - we're working on this)</li>\n        </ol>\n        {% if batches %}\n          <p>Due to limits on the amount of data we can send via email, we have sent the remaining images in seperate emails.</p><p>Please let us know if you are missing any of the batches.</p>\n        {% endif %}\n        {% else %}\n        <h2 style=\"text-align: center; color: #006EB6\">Here are more downloads!</h2>\n        <p>This is image batch {{forloop.index}}/{{image_chunks.size}} for your order <strong>{{order_name}}</strong>.</p>\n        <p>Please find attached the product images <strong>({{zip_filename}})</strong>.</p>    \n       {% endif %}\n    {% endcapture %}\n\n    {% comment %}\n      {{ order.email | json }},\n    {% endcomment %}\n    \n    {% if options.test__boolean %}\n      {% assign to = options.to %}\n    {% else %}\n      {% assign to = email %}\n    {% endif %}\n\n    {% capture zip %}\n      {\n        \"zip\": {\n          \"files\" : {\n            {{ chunk | strip }}\n          }\n        }\n      }\n    {% endcapture %}\n       \n        \n    {% capture attachments %}\n      {% if forloop.index < 2 %}\n        \"{{csv_filename}}\": {{ csv | json }},\n      {% endif %}\n        \"{{zip_filename}}\": {\n          \"zip\": {\n            \"files\" : {\n              {{ chunk | strip }}\n            }\n          }\n        }\n    {% endcapture %}\n    {% action \"email\" %}\n        {\n          \"to\": \"{{to}}\",\n          \"subject\": {{ subject | json }},\n          \"body\": {{ body | strip_newlines | json }},\n          \"reply_to\": {{ shop.customer_email | json }},\n          \"from_display_name\": {{ shop.name | json }},\n          \"attachments\": {\n              {{ attachments | strip }}\n            }\n          }\n      {% endaction %}\n  {% endfor %}\n{% endif %}","docs":null,"halt_action_run_sequence_on_error":true,"liquid_profiling":false,"online_store_javascript":null,"order_status_javascript":null,"perform_action_runs_in_sequence":true,"shopify_api_version":"2021-01"}
